<!DOCTYPE html>
<html lang="en">
<head>
  <title>Parcell - File</title>
  <meta charset="utf-8">
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" type="text/css" href="lib/jk-js/lib/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="lib/font-awesome/css/font-awesome.min.css">
  <script src="lib/jk-js/lib/d3/d3.min.js" charset="utf-8"></script>
  <script src="lib/jk-js/jkjs/cell.js" charset="utf-8"></script>
  <script src="lib/jk-js/jkjs/util.js" charset="utf-8"></script>
  <script src="js/worker.js" charset="utf-8"></script>
  <script src="js/list.js" charset="utf-8"></script>
  <script src="js/net.js" charset="utf-8"></script>
  <style>
  .link {
    cursor: pointer;
  }

  .link:hover {
    color: #a1a1a1;
  }
  </style>
</head>
<body onload="start()">
<div class="container">
  <div class="row" style="margin-top: 5px">
    <div class="col-md-8">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title" style="clear: both;">
            File <span id="filename"></span>
            <span id="back" style="float: right;" class="link">
              &#x2190;
            </span>
          </h3>
        </div>
        <div id="content"></div>
      </div>
    </div>
  </div>
</div>
<script>
function start() {
  var urlArgs = jkjs.util.getQueryStrings();
  var mainDiv = d3.select("#main");

  var _fmt = d3.format(".3g");
  var fmt = function(v) {
    if(Math.floor(v) === v) {
      return "" + v;
    }
    return _fmt(v);
  };

  var net = new Net(d3.select("#status"));
  var work = new quick_server.Worker();
  work.status(function(req) {
    net.otherReq(req);
  });
  var project = net.getProject(urlArgs);
  var server = urlArgs["server"];
  var job = urlArgs["job"];
  var file = urlArgs["file"];

  d3.select("#back").on("click", function() {
    var url = net.url("index.html", {
      "project": project,
      "server": server,
      "job": job + "@" + server,
      "dir": file.includes("/") ? file.replace(/\/[^/]*$/, "") : ".",
    });
    window.location = url;
  });

  var images = [ ".png", ".jpg", ".jpeg", ];
  function get_file() {
    var f = file;
    d3.select("#filename").text(f);
    var args = {
      "project": project,
      "server": server,
      "job": job,
      "file": f,
    };
    var sel = d3.select("#content");
    sel.selectAll("*").remove();
    if(images.some(function(img) {
      return f.endsWith(img);
    })) {
      var imgUrl = net.url("file/", args);
      sel.append("a").attr({
        "href": imgUrl,
      }).append("img").attr({
        "src": imgUrl,
      }).style({
        "width": "100%",
      });
    } else {
      net.getPlain("file", "file/", args, function(text) {
        console.log(text);
        var lines = text.split("\n");
        var ixs = lines.map(function(l, ix) {
          return ix;
        });
        var lsel = sel.selectAll("code").data(ixs, function(ix) {
          return ix;
        });
        lsel.exit().remove();
        var lselE = lsel.enter().append("code");
        lselE.append("span").classed("lineno", true);
        lselE.append("span").classed("line", true);

        lsel.order().style({
          "display": "block",
          "margin-left": 5 + "px",
          "margin-right": 5 + "px",
          "margin-top": function(ix) {
            return ix ? 0 : 5 + "px";
          },
          "margin-bottom": function(ix) {
            return ix < ixs.length - 1 ? 0 : 5 + "px";
          },
        });
        lsel.selectAll(".lineno").text(function(ix) {
          return ix + ": ";
        });
        lsel.selectAll(".line").text(function(ix) {
          return lines[ix];
        });
      });
    }
  } // get_file

  function get_job_status() {
    work.post("job_status", "status/", {
      "project": project,
      "server": server,
      "job": job,
    }, function(data) {
      get_file();
      if(+data["status"]["status"] === 2) {
        setTimeout(get_job_status, 1000);
      }
    });
  } // get_job_status

  get_job_status();
} // start
</script>

</body>
</html>
